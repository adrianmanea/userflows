<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="importmap">
      {
        "imports": {
          "react": "https://esm.sh/react@18.2.0",
          "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
          "lucide-react": "https://esm.sh/lucide-react@0.263.1",
          "framer-motion": "https://esm.sh/framer-motion@11.0.0?deps=react@18.2.0"
        }
      }
    </script>
    <style>
      body {
        margin: 0;
        min-height: 100vh;
      }
    </style>
  </head>
  <body>
    <div id="root"></div>
    <script type="module">
      import React from "react";
      import { createRoot } from "react-dom/client";
      import * as LucideIcons from "lucide-react";
      import * as motion from "framer-motion";

      window.addEventListener("message", (event) => {
        const { type, payload } = event.data;

        if (type === "THEME_CHANGE") {
          if (payload === "dark") {
            document.documentElement.classList.add("dark");
          } else {
            document.documentElement.classList.remove("dark");
          }
        }

        if (type === "RENDER_CODE") {
          const code = payload;
          if (!code) return;

          const rootElement = document.getElementById("root");
          const root = createRoot(rootElement);

          try {
            const strippedCode = code
              .replace(/import\s+.*?from\s+['"].*?['"];?/g, "")
              .replace(/export\s+default\s+/g, "");

            // Add all Lucide icons to scope
            const scope = { React, ...motion, ...LucideIcons };
            const scopeKeys = Object.keys(scope);
            const scopeValues = Object.values(scope);

            const runCode = new Function(
              ...scopeKeys,
              `
                  ${strippedCode}
                  return (typeof Component !== 'undefined' ? Component : ((typeof App !== 'undefined') ? App : null));
              `,
            );

            const Component = runCode(...scopeValues);

            if (Component) {
              root.render(React.createElement(Component));
            } else {
              root.render(
                React.createElement(
                  "div",
                  { className: "text-red-500 p-4" },
                  'Could not find "Component" or "App" function in code.',
                ),
              );
            }
          } catch (err) {
            console.error("Sandbox Render Error:", err);
            root.render(
              React.createElement(
                "div",
                { className: "text-red-500 p-4" },
                "Error: " + err.message,
              ),
            );
          }
        }
      });

      // Signal ready
      window.parent.postMessage({ type: "SANDBOX_READY" }, "*");
    </script>
  </body>
</html>
